#!/usr/bin/env bash

##
# Default configuration
#

# the actual tee command
teebin=tee

case $OSTYPE in
darwin*)
  # a sector of ram disk is 512 bytes
  # allocates 100MB = 512B * 195312 
  preparedir='if [ ! -e /Volumes/ramdisk ]; then diskutil erasevolume HFS+ "ramdisk" `hdiutil attach -nomount ram://195312` || exit 124; fi'
  tmpdir=/Volumes/ramdisk/teemp.$USER
  ;;
linux*)
  # redirect to shared memory filesystem
  preparedir='if [ ! -d /dev/shm ]; then echo "/dev/shm" not found 1>&2; exit 126; fi' 
  tmpdir=/dev/shm/teemp.$USER
  ;;
esac

# file path mangle function
mangler=shasum
# interesting bytes in the mangle function output (GNU cut 'LIST' style)
manglebytes=1-40

##
# Read configuration files
#

# read system configuration
if [ -r /etc/.teemp ]; then 
  # bash 4.0 only
  #source <(egrep -o '^(teebin|tmpdir|mangler|manglebytes)=.*' $PWD/.teemp)
  source /dev/stdin <<< $(egrep -o '^(teebin|tmpdir|mangler|manglebytes|preparedir)=.*' /etc/.teemp)
fi

# read user configuration
if [ -r $HOME/.teemp ]; then
  source /dev/stdin <<< $(egrep -o '^(teebin|tmpdir|mangler|manglebytes|preparedir)=.*' $HOME/.teemp)
fi

# read local configuration
if [ -r $PWD/.teemp ]; then
  source /dev/stdin <<< $(egrep -o '^(teebin|tmpdir|mangler|manglebytes|preparedir)=.*' $PWD/.teemp)
fi

##
# TEEMP
#

eval $preparedir > /dev/null
mkdir -p $tmpdir

for file in $*
do
  case $file in
  --help)
    exec $teebin --help
    exit 128
    ;;
  
  --version)
    exec $teebin --version
    exit 128
    ;;

  -*)
    ;;

  *)
    dirn=$(dirname $file)
    basen=$(basename $file)
    absfile=$(cd $dirn && echo $PWD/$basen)
    
    tmpfile=$(echo $absfile | $mangler | cut -b $manglebytes)
    touch $tmpdir/$tmpfile
    ln -f -s $tmpdir/$tmpfile $absfile
    ;;
  esac
done

exec $teebin $*
exit 128
